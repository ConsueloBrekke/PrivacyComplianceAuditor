<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Privacy Compliance Auditor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: rgba(30, 30, 46, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            max-width: 900px;
            width: 90%;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(94, 234, 212, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #5eead4;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 0 0 20px rgba(94, 234, 212, 0.5);
        }

        .header p {
            color: #94a3b8;
            font-size: 1.1em;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .feature-card {
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(94, 234, 212, 0.3);
        }

        .feature-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 10px 30px rgba(94, 234, 212, 0.3);
        }

        .feature-card h3 {
            font-size: 1.4em;
            margin-bottom: 15px;
        }

        .feature-card p {
            font-size: 1em;
            line-height: 1.6;
        }

        .compliance-standards {
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.2) 0%, rgba(13, 148, 136, 0.2) 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid rgba(94, 234, 212, 0.3);
        }

        .compliance-standards h3 {
            color: #5eead4;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .standards-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .standard-badge {
            background: rgba(20, 184, 166, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9em;
            border: 1px solid rgba(94, 234, 212, 0.5);
        }

        .connection-section {
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.15) 0%, rgba(13, 148, 136, 0.15) 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(94, 234, 212, 0.3);
        }

        .connection-section h3 {
            color: #5eead4;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .connect-button {
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
            color: white;
            padding: 15px 30px;
            border: 1px solid rgba(94, 234, 212, 0.5);
            border-radius: 30px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin: 10px;
        }

        .connect-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(94, 234, 212, 0.4);
        }

        .status-display {
            margin-top: 20px;
            padding: 15px;
            background: rgba(20, 184, 166, 0.2);
            border-radius: 10px;
            display: none;
            border: 1px solid rgba(94, 234, 212, 0.3);
            color: #5eead4;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .info-card {
            background: rgba(20, 184, 166, 0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(94, 234, 212, 0.3);
        }

        .info-card h4 {
            color: #5eead4;
            margin-bottom: 10px;
        }

        .info-card p {
            color: #94a3b8;
            font-weight: 600;
        }

        .input-field {
            background: rgba(20, 184, 166, 0.1);
            border: 1px solid rgba(94, 234, 212, 0.3);
            color: #5eead4;
            padding: 12px;
            border-radius: 8px;
            font-size: 1em;
            width: 100%;
        }

        .input-field::placeholder {
            color: #64748b;
        }

        .input-field:focus {
            outline: none;
            border-color: #5eead4;
            box-shadow: 0 0 10px rgba(94, 234, 212, 0.3);
        }

        select.input-field {
            cursor: pointer;
        }

        label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîí Privacy Compliance Auditor</h1>
            <p>Confidential compliance checking using Zama Fully Homomorphic Encryption</p>
        </div>

        <div class="features-grid">
            <div class="feature-card">
                <h3>üõ°Ô∏è Confidential Auditing</h3>
                <p>Perform compliance audits while keeping sensitive data encrypted throughout the process</p>
            </div>

            <div class="feature-card">
                <h3>üìä Risk Assessment</h3>
                <p>Encrypted risk scoring and compliance evaluation with complete privacy preservation</p>
            </div>

            <div class="feature-card">
                <h3>üìã Regulatory Compliance</h3>
                <p>Support for major privacy regulations including GDPR, CCPA, HIPAA, and more</p>
            </div>

            <div class="feature-card">
                <h3>üéØ Data Processing Registry</h3>
                <p>Confidential registration and tracking of data processing activities</p>
            </div>
        </div>

        <div class="compliance-standards">
            <h3>Supported Compliance Standards</h3>
            <div class="standards-list">
                <span class="standard-badge">GDPR</span>
                <span class="standard-badge">CCPA</span>
                <span class="standard-badge">HIPAA</span>
                <span class="standard-badge">SOX</span>
                <span class="standard-badge">PCI-DSS</span>
                <span class="standard-badge">ISO 27001</span>
            </div>
        </div>

        <div class="connection-section">
            <h3>Connect to Blockchain</h3>
            <button class="connect-button" onclick="connectWallet()">Connect Wallet</button>
            <button class="connect-button" onclick="loadContract()">Load Contract</button>

            <div class="status-display" id="statusDisplay">
                <p id="connectionStatus">Not connected</p>
            </div>

            <div class="info-grid">
                <div class="info-card">
                    <h4>Network</h4>
                    <p id="networkInfo">Sepolia Testnet</p>
                </div>
                <div class="info-card">
                    <h4>Contract Status</h4>
                    <p id="contractStatus">Not loaded</p>
                </div>
                <div class="info-card">
                    <h4>User Role</h4>
                    <p id="userRole">Unknown</p>
                </div>
                <div class="info-card">
                    <h4>Total Audits</h4>
                    <p id="auditCount">0</p>
                </div>
            </div>
        </div>

        <!-- Interaction Sections -->
        <div id="interactionSections" style="display: none; margin-top: 30px;">

            <!-- Register Compliance Data -->
            <div class="compliance-standards">
                <h3>üìä Register Compliance Data</h3>
                <div style="display: grid; gap: 15px;">
                    <input type="number" id="dataPoints" placeholder="Data Points Count" class="input-field">
                    <input type="number" id="riskScore" placeholder="Risk Score (0-100)" min="0" max="100" class="input-field">
                    <input type="number" id="complianceScore" placeholder="Compliance Score (0-100)" min="0" max="100" class="input-field">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <label style="color: #5eead4;"><input type="checkbox" id="hasPersonalData"> Has Personal Data</label>
                        <label style="color: #5eead4;"><input type="checkbox" id="hasFinancialData"> Has Financial Data</label>
                        <label style="color: #5eead4;"><input type="checkbox" id="hasHealthData"> Has Health Data</label>
                    </div>
                    <button class="connect-button" onclick="registerComplianceData()">Register Data</button>
                </div>
            </div>

            <!-- Schedule Audit -->
            <div class="compliance-standards">
                <h3>üìÖ Schedule Audit</h3>
                <div style="display: grid; gap: 15px;">
                    <input type="text" id="auditeeAddress" placeholder="Auditee Address (0x...)" class="input-field">
                    <select id="auditStandard" class="input-field">
                        <option value="0">GDPR</option>
                        <option value="1">CCPA</option>
                        <option value="2">HIPAA</option>
                        <option value="3">SOX</option>
                        <option value="4">PCI-DSS</option>
                        <option value="5">ISO 27001</option>
                    </select>
                    <button class="connect-button" onclick="scheduleAudit()">Schedule Audit</button>
                </div>
            </div>

            <!-- Complete Audit -->
            <div class="compliance-standards">
                <h3>‚úÖ Complete Audit</h3>
                <div style="display: grid; gap: 15px;">
                    <input type="number" id="auditIdComplete" placeholder="Audit ID" class="input-field">
                    <input type="number" id="findingsCount" placeholder="Findings Count" min="0" class="input-field">
                    <input type="number" id="riskLevel" placeholder="Risk Level (0-100)" min="0" max="100" class="input-field">
                    <input type="number" id="penaltyAmount" placeholder="Penalty Amount" class="input-field">
                    <label style="color: #5eead4;"><input type="checkbox" id="remediated"> Issues Remediated</label>
                    <button class="connect-button" onclick="completeAudit()">Complete Audit</button>
                </div>
            </div>

            <!-- Register Data Processing Activity -->
            <div class="compliance-standards">
                <h3>üìù Register Data Processing Activity</h3>
                <div style="display: grid; gap: 15px;">
                    <input type="text" id="activityId" placeholder="Activity ID (e.g., marketing-2024)" class="input-field">
                    <select id="processingPurpose" class="input-field">
                        <option value="0">Marketing</option>
                        <option value="1">Analytics</option>
                        <option value="2">Legal</option>
                        <option value="3">Research</option>
                        <option value="4">Operations</option>
                    </select>
                    <input type="number" id="dataSubjectCount" placeholder="Data Subject Count" class="input-field">
                    <input type="number" id="retentionPeriod" placeholder="Retention Period (months)" class="input-field">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <label style="color: #5eead4;"><input type="checkbox" id="consentObtained"> Consent Obtained</label>
                        <label style="color: #5eead4;"><input type="checkbox" id="dataMinimized"> Data Minimized</label>
                        <label style="color: #5eead4;"><input type="checkbox" id="securityMeasures"> Security Measures</label>
                    </div>
                    <button class="connect-button" onclick="registerDataProcessing()">Register Activity</button>
                </div>
            </div>

            <!-- Grant/Revoke Certification -->
            <div class="compliance-standards">
                <h3>üèÜ Manage Certifications</h3>
                <div style="display: grid; gap: 15px;">
                    <input type="text" id="certEntity" placeholder="Entity Address (0x...)" class="input-field">
                    <select id="certStandard" class="input-field">
                        <option value="0">GDPR</option>
                        <option value="1">CCPA</option>
                        <option value="2">HIPAA</option>
                        <option value="3">SOX</option>
                        <option value="4">PCI-DSS</option>
                        <option value="5">ISO 27001</option>
                    </select>
                    <div style="display: flex; gap: 10px;">
                        <button class="connect-button" onclick="grantCertification()">Grant Certification</button>
                        <button class="connect-button" onclick="revokeCertification()">Revoke Certification</button>
                    </div>
                </div>
            </div>

            <!-- Query Functions -->
            <div class="compliance-standards">
                <h3>üîç Query Information</h3>
                <div style="display: grid; gap: 15px;">
                    <input type="text" id="queryAddress" placeholder="Query Address (0x...)" class="input-field">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="connect-button" onclick="getComplianceStatus()">Get Compliance Status</button>
                        <button class="connect-button" onclick="checkAuthorizations()">Check Authorizations</button>
                    </div>
                    <input type="number" id="queryAuditId" placeholder="Audit ID" class="input-field">
                    <button class="connect-button" onclick="getAuditInfo()">Get Audit Info</button>
                </div>
            </div>

            <!-- Results Display -->
            <div class="compliance-standards" id="resultsSection" style="display: none;">
                <h3>üìã Results</h3>
                <pre id="resultsDisplay" style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px; color: #5eead4; overflow-x: auto; white-space: pre-wrap;"></pre>
            </div>

            <!-- Admin Functions -->
            <div class="compliance-standards" id="adminSection" style="display: none;">
                <h3>‚öôÔ∏è Admin Functions (Owner Only)</h3>
                <div style="display: grid; gap: 15px;">
                    <input type="text" id="regulatorAddress" placeholder="Regulator Address (0x...)" class="input-field">
                    <button class="connect-button" onclick="setRegulator()">Set Regulator</button>

                    <input type="text" id="auditorAddress" placeholder="Auditor Address (0x...)" class="input-field">
                    <div style="display: flex; gap: 10px;">
                        <button class="connect-button" onclick="authorizeAuditor()">Authorize Auditor</button>
                        <button class="connect-button" onclick="revokeAuditor()">Revoke Auditor</button>
                    </div>

                    <input type="text" id="controllerAddress" placeholder="Controller Address (0x...)" class="input-field">
                    <button class="connect-button" onclick="authorizeDataController()">Authorize Data Controller</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // Contract configuration
        const CONTRACT_ADDRESS = "0xf7f80e8BE9823E5D8df70960cECd7f7A24266098";
        const CONTRACT_ABI = [
            "function owner() view returns (address)",
            "function regulator() view returns (address)",
            "function auditCount() view returns (uint32)",
            "function lastAuditTime() view returns (uint256)",
            "function setRegulator(address _regulator)",
            "function authorizeAuditor(address _auditor)",
            "function revokeAuditor(address _auditor)",
            "function authorizeDataController(address _controller)",
            "function registerComplianceData(uint32 _dataPoints, uint8 _riskScore, uint8 _complianceScore, bool _hasPersonalData, bool _hasFinancialData, bool _hasHealthData)",
            "function scheduleAudit(address _auditee, uint8 _standard)",
            "function completeAudit(uint32 _auditId, uint8 _findingsCount, uint8 _riskLevel, uint32 _penaltyAmount, bool _remediated)",
            "function registerDataProcessingActivity(bytes32 _activityId, uint8 _processingPurpose, uint32 _dataSubjectCount, uint8 _retentionPeriod, bool _consentObtained, bool _dataMinimized, bool _securityMeasures)",
            "function grantCertification(address _entity, uint8 _standard)",
            "function revokeCertification(address _entity, uint8 _standard)",
            "function getComplianceStatus(address _entity) view returns (bool hasPersonalData, bool hasFinancialData, bool hasHealthData, uint256 lastReviewDate, address dataController)",
            "function getAuditInfo(uint32 _auditId) view returns (uint8 standard, uint8 status, uint8 overallRisk, address auditor, address auditee, uint256 startTime, uint256 endTime, bool remediated)",
            "function hasCertification(address _entity, uint8 _standard) view returns (bool)",
            "function getCurrentAuditCount() view returns (uint32)",
            "function isAuthorizedAuditor(address _auditor) view returns (bool)",
            "function isDataController(address _controller) view returns (bool)",
            "event ComplianceDataUpdated(address indexed entity, uint256 timestamp)",
            "event AuditScheduled(uint32 indexed auditId, address indexed auditee, uint8 standard)",
            "event AuditCompleted(uint32 indexed auditId, uint8 overallRisk, bool remediated)",
            "event ViolationDetected(address indexed entity, uint8 standard, uint8 severity)",
            "event CertificationGranted(address indexed entity, uint8 standard)",
            "event CertificationRevoked(address indexed entity, uint8 standard)",
            "event DataProcessingRegistered(bytes32 indexed activityId, address indexed controller)",
            "event ComplianceScoreUpdated(address indexed entity, uint256 timestamp)"
        ];

        let provider;
        let signer;
        let contract;
        let userAddress;
        let isWalletConnected = false;

        async function connectWallet() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    // Request account access
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });

                    if (accounts.length === 0) {
                        alert('No accounts found. Please unlock MetaMask.');
                        return;
                    }

                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    isWalletConnected = true;

                    // Update UI
                    document.getElementById('statusDisplay').style.display = 'block';
                    document.getElementById('connectionStatus').textContent = `Connected: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;

                    // Get network info
                    const network = await provider.getNetwork();
                    document.getElementById('networkInfo').textContent = network.name;

                    console.log('Wallet connected:', userAddress);
                    alert('Wallet connected successfully!');
                } else {
                    alert('Please install MetaMask to use this application');
                }
            } catch (error) {
                console.error('Error connecting wallet:', error);
                alert('Failed to connect wallet: ' + error.message);
                isWalletConnected = false;
            }
        }

        async function loadContract() {
            try {
                // Show loading state
                document.getElementById('contractStatus').textContent = 'Loading...';

                // Re-initialize provider and signer if needed
                if (!isWalletConnected || !provider || !signer) {
                    if (typeof window.ethereum !== 'undefined') {
                        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                        if (accounts.length === 0) {
                            alert('Please connect your wallet first');
                            document.getElementById('contractStatus').textContent = 'Not loaded';
                            return;
                        }
                        provider = new ethers.providers.Web3Provider(window.ethereum);
                        signer = provider.getSigner();
                        userAddress = await signer.getAddress();
                        isWalletConnected = true;

                        // Update connection status if it wasn't shown
                        document.getElementById('statusDisplay').style.display = 'block';
                        document.getElementById('connectionStatus').textContent = `Connected: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                    } else {
                        alert('Please connect your wallet first');
                        document.getElementById('contractStatus').textContent = 'Not loaded';
                        return;
                    }
                }

                if (!CONTRACT_ADDRESS) {
                    alert('Contract address not configured. Please deploy the contract first.');
                    document.getElementById('contractStatus').textContent = 'Not configured';
                    return;
                }

                // Load contract
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                // Get contract info
                const owner = await contract.owner();
                const regulator = await contract.regulator();
                const auditCount = await contract.getCurrentAuditCount();

                // Check user roles
                const isAuditor = await contract.isAuthorizedAuditor(userAddress);
                const isController = await contract.isDataController(userAddress);

                let role = "User";
                let roleColor = "#94a3b8";

                if (userAddress.toLowerCase() === owner.toLowerCase()) {
                    role = "Owner";
                    roleColor = "#fbbf24";
                } else if (userAddress.toLowerCase() === regulator.toLowerCase()) {
                    role = "Regulator";
                    roleColor = "#f472b6";
                } else if (isAuditor) {
                    role = "Auditor";
                    roleColor = "#60a5fa";
                } else if (isController) {
                    role = "Data Controller";
                    roleColor = "#a78bfa";
                }

                // Update UI with colors
                const contractStatusEl = document.getElementById('contractStatus');
                const userRoleEl = document.getElementById('userRole');
                const auditCountEl = document.getElementById('auditCount');

                contractStatusEl.textContent = '‚úì Loaded';
                contractStatusEl.style.color = '#5eead4';
                userRoleEl.textContent = role;
                userRoleEl.style.color = roleColor;
                auditCountEl.textContent = auditCount.toString();

                console.log('Contract loaded successfully');
                console.log('Owner:', owner);
                console.log('User role:', role);
                console.log('Audit count:', auditCount.toString());

                // Show interaction sections
                document.getElementById('interactionSections').style.display = 'block';

                // Show admin section if owner
                if (role === 'Owner') {
                    document.getElementById('adminSection').style.display = 'block';
                }

                alert(`Contract loaded successfully!\nYour role: ${role}\nTotal audits: ${auditCount}`);

            } catch (error) {
                console.error('Error loading contract:', error);
                alert('Failed to load contract: ' + error.message);
                document.getElementById('contractStatus').textContent = '‚úó Error';
                document.getElementById('contractStatus').style.color = '#f87171';
            }
        }

        // Helper function to show results
        function showResults(data) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsDisplay = document.getElementById('resultsDisplay');
            resultsDisplay.textContent = JSON.stringify(data, null, 2);
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Register Compliance Data
        async function registerComplianceData() {
            try {
                if (!contract) {
                    alert('Please load contract first');
                    return;
                }

                const dataPoints = document.getElementById('dataPoints').value;
                const riskScore = document.getElementById('riskScore').value;
                const complianceScore = document.getElementById('complianceScore').value;
                const hasPersonalData = document.getElementById('hasPersonalData').checked;
                const hasFinancialData = document.getElementById('hasFinancialData').checked;
                const hasHealthData = document.getElementById('hasHealthData').checked;

                if (!dataPoints || !riskScore || !complianceScore) {
                    alert('Please fill in all required fields');
                    return;
                }

                console.log('Registering compliance data...');
                const tx = await contract.registerComplianceData(
                    dataPoints,
                    riskScore,
                    complianceScore,
                    hasPersonalData,
                    hasFinancialData,
                    hasHealthData
                );

                alert('Transaction submitted! Waiting for confirmation...');
                const receipt = await tx.wait();

                showResults({
                    success: true,
                    message: 'Compliance data registered successfully',
                    transactionHash: receipt.transactionHash,
                    blockNumber: receipt.blockNumber
                });

                console.log('Compliance data registered:', receipt);
            } catch (error) {
                console.error('Error registering compliance data:', error);
                alert('Failed to register compliance data: ' + error.message);
            }
        }

        // Schedule Audit
        async function scheduleAudit() {
            try {
                if (!contract) {
                    alert('Please load contract first');
                    return;
                }

                const auditeeAddress = document.getElementById('auditeeAddress').value;
                const standard = document.getElementById('auditStandard').value;

                if (!auditeeAddress || !ethers.utils.isAddress(auditeeAddress)) {
                    alert('Please enter a valid auditee address');
                    return;
                }

                console.log('Scheduling audit...');
                const tx = await contract.scheduleAudit(auditeeAddress, standard);

                alert('Transaction submitted! Waiting for confirmation...');
                const receipt = await tx.wait();

                // Get audit ID from event
                const event = receipt.events.find(e => e.event === 'AuditScheduled');
                const auditId = event ? event.args.auditId.toString() : 'Unknown';

                showResults({
                    success: true,
                    message: 'Audit scheduled successfully',
                    auditId: auditId,
                    transactionHash: receipt.transactionHash,
                    blockNumber: receipt.blockNumber
                });

                console.log('Audit scheduled:', receipt);
            } catch (error) {
                console.error('Error scheduling audit:', error);
                alert('Failed to schedule audit: ' + error.message);
            }
        }

        // Complete Audit
        async function completeAudit() {
            try {
                if (!contract) {
                    alert('Please load contract first');
                    return;
                }

                const auditId = document.getElementById('auditIdComplete').value;
                const findingsCount = document.getElementById('findingsCount').value;
                const riskLevel = document.getElementById('riskLevel').value;
                const penaltyAmount = document.getElementById('penaltyAmount').value;
                const remediated = document.getElementById('remediated').checked;

                if (!auditId || !findingsCount || !riskLevel || !penaltyAmount) {
                    alert('Please fill in all required fields');
                    return;
                }

                console.log('Completing audit...');
                const tx = await contract.completeAudit(
                    auditId,
                    findingsCount,
                    riskLevel,
                    penaltyAmount,
                    remediated
                );

                alert('Transaction submitted! Waiting for confirmation...');
                const receipt = await tx.wait();

                showResults({
                    success: true,
                    message: 'Audit completed successfully',
                    auditId: auditId,
                    transactionHash: receipt.transactionHash,
                    blockNumber: receipt.blockNumber
                });

                console.log('Audit completed:', receipt);
            } catch (error) {
                console.error('Error completing audit:', error);
                alert('Failed to complete audit: ' + error.message);
            }
        }

        // Register Data Processing Activity
        async function registerDataProcessing() {
            try {
                if (!contract) {
                    alert('Please load contract first');
                    return;
                }

                const activityId = document.getElementById('activityId').value;
                const processingPurpose = document.getElementById('processingPurpose').value;
                const dataSubjectCount = document.getElementById('dataSubjectCount').value;
                const retentionPeriod = document.getElementById('retentionPeriod').value;
                const consentObtained = document.getElementById('consentObtained').checked;
                const dataMinimized = document.getElementById('dataMinimized').checked;
                const securityMeasures = document.getElementById('securityMeasures').checked;

                if (!activityId || !dataSubjectCount || !retentionPeriod) {
                    alert('Please fill in all required fields');
                    return;
                }

                // Convert activity ID to bytes32
                const activityIdBytes32 = ethers.utils.formatBytes32String(activityId);

                console.log('Registering data processing activity...');
                const tx = await contract.registerDataProcessingActivity(
                    activityIdBytes32,
                    processingPurpose,
                    dataSubjectCount,
                    retentionPeriod,
                    consentObtained,
                    dataMinimized,
                    securityMeasures
                );

                alert('Transaction submitted! Waiting for confirmation...');
                const receipt = await tx.wait();

                showResults({
                    success: true,
                    message: 'Data processing activity registered successfully',
                    activityId: activityId,
                    transactionHash: receipt.transactionHash,
                    blockNumber: receipt.blockNumber
                });

                console.log('Data processing activity registered:', receipt);
            } catch (error) {
                console.error('Error registering data processing activity:', error);
                alert('Failed to register activity: ' + error.message);
            }
        }

        // Grant Certification
        async function grantCertification() {
            try {
                if (!contract) {
                    alert('Please load contract first');
                    return;
                }

                const entityAddress = document.getElementById('certEntity').value;
                const standard = document.getElementById('certStandard').value;

                if (!entityAddress || !ethers.utils.isAddress(entityAddress)) {
                    alert('Please enter a valid entity address');
                    return;
                }

                console.log('Granting certification...');
                const tx = await contract.grantCertification(entityAddress, standard);

                alert('Transaction submitted! Waiting for confirmation...');
                const receipt = await tx.wait();

                showResults({
                    success: true,
                    message: 'Certification granted successfully',
                    entity: entityAddress,
                    standard: document.getElementById('certStandard').options[standard].text,
                    transactionHash: receipt.transactionHash,
                    blockNumber: receipt.blockNumber
                });

                console.log('Certification granted:', receipt);
            } catch (error) {
                console.error('Error granting certification:', error);
                alert('Failed to grant certification: ' + error.message);
            }
        }

        // Revoke Certification
        async function revokeCertification() {
            try {
                if (!contract) {
                    alert('Please load contract first');
                    return;
                }

                const entityAddress = document.getElementById('certEntity').value;
                const standard = document.getElementById('certStandard').value;

                if (!entityAddress || !ethers.utils.isAddress(entityAddress)) {
                    alert('Please enter a valid entity address');
                    return;
                }

                console.log('Revoking certification...');
                const tx = await contract.revokeCertification(entityAddress, standard);

                alert('Transaction submitted! Waiting for confirmation...');
                const receipt = await tx.wait();

                showResults({
                    success: true,
                    message: 'Certification revoked successfully',
                    entity: entityAddress,
                    standard: document.getElementById('certStandard').options[standard].text,
                    transactionHash: receipt.transactionHash,
                    blockNumber: receipt.blockNumber
                });

                console.log('Certification revoked:', receipt);
            } catch (error) {
                console.error('Error revoking certification:', error);
                alert('Failed to revoke certification: ' + error.message);
            }
        }

        // Get Compliance Status
        async function getComplianceStatus() {
            try {
                if (!contract) {
                    alert('Please load contract first');
                    return;
                }

                const queryAddress = document.getElementById('queryAddress').value;

                if (!queryAddress || !ethers.utils.isAddress(queryAddress)) {
                    alert('Please enter a valid address');
                    return;
                }

                console.log('Getting compliance status...');
                const status = await contract.getComplianceStatus(queryAddress);

                showResults({
                    address: queryAddress,
                    hasPersonalData: status.hasPersonalData,
                    hasFinancialData: status.hasFinancialData,
                    hasHealthData: status.hasHealthData,
                    lastReviewDate: new Date(status.lastReviewDate.toNumber() * 1000).toLocaleString(),
                    dataController: status.dataController
                });

                console.log('Compliance status:', status);
            } catch (error) {
                console.error('Error getting compliance status:', error);
                alert('Failed to get compliance status: ' + error.message);
            }
        }

        // Check Authorizations
        async function checkAuthorizations() {
            try {
                if (!contract) {
                    alert('Please load contract first');
                    return;
                }

                const queryAddress = document.getElementById('queryAddress').value;

                if (!queryAddress || !ethers.utils.isAddress(queryAddress)) {
                    alert('Please enter a valid address');
                    return;
                }

                console.log('Checking authorizations...');
                const isAuditor = await contract.isAuthorizedAuditor(queryAddress);
                const isController = await contract.isDataController(queryAddress);
                const owner = await contract.owner();
                const regulator = await contract.regulator();

                showResults({
                    address: queryAddress,
                    isOwner: queryAddress.toLowerCase() === owner.toLowerCase(),
                    isRegulator: queryAddress.toLowerCase() === regulator.toLowerCase(),
                    isAuthorizedAuditor: isAuditor,
                    isDataController: isController
                });

                console.log('Authorizations:', { isAuditor, isController });
            } catch (error) {
                console.error('Error checking authorizations:', error);
                alert('Failed to check authorizations: ' + error.message);
            }
        }

        // Get Audit Info
        async function getAuditInfo() {
            try {
                if (!contract) {
                    alert('Please load contract first');
                    return;
                }

                const auditId = document.getElementById('queryAuditId').value;

                if (!auditId) {
                    alert('Please enter an audit ID');
                    return;
                }

                console.log('Getting audit info...');
                const info = await contract.getAuditInfo(auditId);

                const standards = ['GDPR', 'CCPA', 'HIPAA', 'SOX', 'PCI-DSS', 'ISO 27001'];
                const statuses = ['Scheduled', 'In Progress', 'Completed', 'Failed'];

                showResults({
                    auditId: auditId,
                    standard: standards[info.standard] || info.standard,
                    status: statuses[info.status] || info.status,
                    overallRisk: info.overallRisk.toString(),
                    auditor: info.auditor,
                    auditee: info.auditee,
                    startTime: new Date(info.startTime.toNumber() * 1000).toLocaleString(),
                    endTime: info.endTime.toNumber() > 0 ? new Date(info.endTime.toNumber() * 1000).toLocaleString() : 'Not completed',
                    remediated: info.remediated
                });

                console.log('Audit info:', info);
            } catch (error) {
                console.error('Error getting audit info:', error);
                alert('Failed to get audit info: ' + error.message);
            }
        }

        // Admin Functions
        async function setRegulator() {
            try {
                if (!contract) {
                    alert('Please load contract first');
                    return;
                }

                const regulatorAddress = document.getElementById('regulatorAddress').value;

                if (!regulatorAddress || !ethers.utils.isAddress(regulatorAddress)) {
                    alert('Please enter a valid regulator address');
                    return;
                }

                console.log('Setting regulator...');
                const tx = await contract.setRegulator(regulatorAddress);

                alert('Transaction submitted! Waiting for confirmation...');
                const receipt = await tx.wait();

                showResults({
                    success: true,
                    message: 'Regulator set successfully',
                    regulator: regulatorAddress,
                    transactionHash: receipt.transactionHash
                });

                console.log('Regulator set:', receipt);
            } catch (error) {
                console.error('Error setting regulator:', error);
                alert('Failed to set regulator: ' + error.message);
            }
        }

        async function authorizeAuditor() {
            try {
                if (!contract) {
                    alert('Please load contract first');
                    return;
                }

                const auditorAddress = document.getElementById('auditorAddress').value;

                if (!auditorAddress || !ethers.utils.isAddress(auditorAddress)) {
                    alert('Please enter a valid auditor address');
                    return;
                }

                console.log('Authorizing auditor...');
                const tx = await contract.authorizeAuditor(auditorAddress);

                alert('Transaction submitted! Waiting for confirmation...');
                const receipt = await tx.wait();

                showResults({
                    success: true,
                    message: 'Auditor authorized successfully',
                    auditor: auditorAddress,
                    transactionHash: receipt.transactionHash
                });

                console.log('Auditor authorized:', receipt);
            } catch (error) {
                console.error('Error authorizing auditor:', error);
                alert('Failed to authorize auditor: ' + error.message);
            }
        }

        async function revokeAuditor() {
            try {
                if (!contract) {
                    alert('Please load contract first');
                    return;
                }

                const auditorAddress = document.getElementById('auditorAddress').value;

                if (!auditorAddress || !ethers.utils.isAddress(auditorAddress)) {
                    alert('Please enter a valid auditor address');
                    return;
                }

                console.log('Revoking auditor...');
                const tx = await contract.revokeAuditor(auditorAddress);

                alert('Transaction submitted! Waiting for confirmation...');
                const receipt = await tx.wait();

                showResults({
                    success: true,
                    message: 'Auditor revoked successfully',
                    auditor: auditorAddress,
                    transactionHash: receipt.transactionHash
                });

                console.log('Auditor revoked:', receipt);
            } catch (error) {
                console.error('Error revoking auditor:', error);
                alert('Failed to revoke auditor: ' + error.message);
            }
        }

        async function authorizeDataController() {
            try {
                if (!contract) {
                    alert('Please load contract first');
                    return;
                }

                const controllerAddress = document.getElementById('controllerAddress').value;

                if (!controllerAddress || !ethers.utils.isAddress(controllerAddress)) {
                    alert('Please enter a valid controller address');
                    return;
                }

                console.log('Authorizing data controller...');
                const tx = await contract.authorizeDataController(controllerAddress);

                alert('Transaction submitted! Waiting for confirmation...');
                const receipt = await tx.wait();

                showResults({
                    success: true,
                    message: 'Data controller authorized successfully',
                    controller: controllerAddress,
                    transactionHash: receipt.transactionHash
                });

                console.log('Data controller authorized:', receipt);
            } catch (error) {
                console.error('Error authorizing data controller:', error);
                alert('Failed to authorize data controller: ' + error.message);
            }
        }

        // Listen for account changes
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    // User disconnected
                    isWalletConnected = false;
                    provider = null;
                    signer = null;
                    userAddress = null;
                    document.getElementById('statusDisplay').style.display = 'none';
                    document.getElementById('contractStatus').textContent = 'Not loaded';
                    document.getElementById('userRole').textContent = 'Unknown';
                } else {
                    // User switched accounts
                    location.reload();
                }
            });

            window.ethereum.on('chainChanged', function (chainId) {
                // User switched networks
                location.reload();
            });
        }

        // Additional functions for contract interactions would be added here
        // For example: registerComplianceData, scheduleAudit, etc.
    </script>
</body>
</html>